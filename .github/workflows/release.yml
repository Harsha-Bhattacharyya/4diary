name: Main Release

on:
  push:
    tags:
      - 'v*.*.*' # Trigger on version tags like v1.0.0, v0.1.0-alpha, etc.
  workflow_dispatch: # Allow manual trigger
    inputs:
      tag:
        description: 'Tag name (e.g., v1.0.0)'
        required: true
        type: string

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
      with:
        fetch-depth: 0 # Fetch all history for changelog
    
    - name: Use Node.js
      uses: actions/setup-node@v6
      with:
        node-version: '22.x'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run linter
      run: npm run lint
    
    - name: Build project
      run: npm run build
    
    - name: Run tests
      run: npm test
    
    - name: Get version from tag
      id: version
      run: |
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          TAG_NAME="${{ github.event.inputs.tag }}"
        else
          TAG_NAME="${GITHUB_REF#refs/tags/}"
        fi
        echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
        
        # Extract version without 'v' prefix
        VERSION="${TAG_NAME#v}"
        echo "version=$VERSION" >> $GITHUB_OUTPUT
    
    - name: Get previous release tag
      id: previous_tag
      run: |
        # Get the previous version tag (excluding nightly builds)
        PREV_TAG=$(git tag -l "v*.*.*" | grep -v "${{ steps.version.outputs.tag_name }}" | sort -V | tail -n 1)
        
        if [ -z "$PREV_TAG" ]; then
          echo "previous_tag=" >> $GITHUB_OUTPUT
          echo "No previous release tag found"
        else
          echo "previous_tag=$PREV_TAG" >> $GITHUB_OUTPUT
          echo "Previous release: $PREV_TAG"
        fi
    
    - name: Generate changelog (excluding "Initial plan" commits)
      id: changelog
      run: |
        PREV_TAG="${{ steps.previous_tag.outputs.previous_tag }}"
        TAG_NAME="${{ steps.version.outputs.tag_name }}"
        
        if [ -z "$PREV_TAG" ]; then
          # First release - get all commits
          COMMITS=$(git log --oneline --no-merges --grep="Initial plan" --invert-grep)
        else
          # Get commits between previous tag and current
          COMMITS=$(git log ${PREV_TAG}..HEAD --oneline --no-merges --grep="Initial plan" --invert-grep)
        fi
        
        # Generate formatted changelog
        {
          echo "changelog<<EOF"
          echo "## Release $TAG_NAME"
          echo ""
          echo "### What's Changed"
          echo ""
          
          if [ -z "$COMMITS" ]; then
            echo "No changes in this release."
          else
            # Show features (commits with "feat:" or "feat(" or starting with "Add")
            FEATURES=$(echo "$COMMITS" | grep -iE '^[a-f0-9]+ (feat[:(]|Add )' || true)
            if [ -n "$FEATURES" ]; then
              echo "#### Features"
              echo "$FEATURES" | sed 's/^/- /'
              echo ""
            fi
            
            # Show fixes (commits with "fix:" or "fix(" or starting with "Fix")
            FIXES=$(echo "$COMMITS" | grep -iE '^[a-f0-9]+ (fix[:(]|Fix )' || true)
            if [ -n "$FIXES" ]; then
              echo "#### Bug Fixes"
              echo "$FIXES" | sed 's/^/- /'
              echo ""
            fi
            
            # Show other changes (exclude features and fixes)
            OTHER=$(echo "$COMMITS" | grep -v -iE '^[a-f0-9]+ (feat[:(]|fix[:(]|Add |Fix )' || true)
            if [ -n "$OTHER" ]; then
              echo "#### Other Changes"
              echo "$OTHER" | sed 's/^/- /'
            fi
          fi
          
          echo ""
          echo "**Full Changelog**: "
          if [ -z "$PREV_TAG" ]; then
            echo "First release"
          else
            echo "[\`${PREV_TAG}...${TAG_NAME}\`](https://github.com/${{ github.repository }}/compare/${PREV_TAG}...${TAG_NAME})"
          fi
          echo "EOF"
        } >> $GITHUB_OUTPUT
    
    - name: Create or update release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        TAG_NAME="${{ steps.version.outputs.tag_name }}"
        
        # Check if this is a pre-release (alpha, beta, rc)
        if [[ "$TAG_NAME" =~ -(alpha|beta|rc) ]]; then
          PRERELEASE="--prerelease"
        else
          PRERELEASE=""
        fi
        
        # Check if tag already exists
        if git rev-parse "$TAG_NAME" >/dev/null 2>&1; then
          echo "Tag $TAG_NAME already exists"
          
          # Check if release exists
          if gh release view "$TAG_NAME" >/dev/null 2>&1; then
            echo "Release already exists, updating..."
            gh release edit "$TAG_NAME" \
              --title "Release $TAG_NAME" \
              --notes "${{ steps.changelog.outputs.changelog }}"
          else
            echo "Creating release for existing tag..."
            gh release create "$TAG_NAME" \
              --title "Release $TAG_NAME" \
              --notes "${{ steps.changelog.outputs.changelog }}" \
              $PRERELEASE
          fi
        else
          echo "Creating new tag and release..."
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git tag -a "$TAG_NAME" -m "Release $TAG_NAME"
          git push origin "$TAG_NAME"
          
          gh release create "$TAG_NAME" \
            --title "Release $TAG_NAME" \
            --notes "${{ steps.changelog.outputs.changelog }}" \
            $PRERELEASE
        fi
    
    - name: Update package version
      if: github.event_name == 'workflow_dispatch'
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        npm version "$VERSION" --no-git-tag-version --allow-same-version
        
        echo "Updated package.json to version $VERSION"
